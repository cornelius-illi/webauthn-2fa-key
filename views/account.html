<!--
 * @license
 * Copyright 2021 Google Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WebAuthn with a security key Codelab</title>
    <meta
      name="description"
      content="Codelab: two-factor authentication with a security key and WebAuthn"
    />
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/main.css" />
  </head>
  <body>
    <div class="outer-container">
      <header class="header">
        <div class="header-container">
          <div class="logo-container">
            <span class="db-logo db-logo--size-s t:db-logo--size-m db-logo--auto">
              <svg viewBox="0 0 40 28" class="db-logo__db"><rect x="2" y="2" width="36" height="24"></rect><path d="M35.9 0c2.13 0 3.98 1.6 4.1 3.7v20.2a4.12 4.12 0 01-3.9 4.1H4c-2.13 0-3.9-1.7-4-3.9V3.9C0 1.77 1.69.1 3.8 0h32.1zm0 3H4c-.56 0-.95.44-1 .98V23.8c0 .56.35 1.12.88 1.2H35.9c.56 0 1.03-.52 1.1-1.08V4.1c0-.6-.5-1.1-1.1-1.1zM12.2 4.8c4.7 0 7.3 3 7.3 9.1 0 5.3-1.7 9.2-7.3 9.2H5.5V4.8h6.7zm16.9 0c5.2 0 5.3 4.1 5.3 4.5 0 2.4-1.9 3.9-3.2 4.2 3.3.8 3.8 3.2 3.8 4.5 0 4.83-4.75 5.09-6.78 5.1H21.5V4.8zM10.7 7.7h-.8v12.4h1.5c2.4 0 3.7-1.8 3.7-5.9 0-3.6-.4-6.5-4.4-6.5zm17.1 7.7h-2v4.7h1.8c.7 0 3 0 3-2.3 0-1-.6-2.4-2.8-2.4zm-.6-7.8h-1.4V12h1.8c1.5 0 2.4-1 2.4-2.2 0-1.5-.8-2.2-2.8-2.2z"></path></svg>
            </span>
          </div>
          <span>
            <button class="db-button db-button--hover-only db-button--round db-button--size-l" type="button" aria-haspopup="true" aria-controls="menu--1" data-testid="button-toggle-headermenu" id="menu-button--menu" data-reach-menu-button="" title="Hauptmenü">
              <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="css-4iwsvz" role="img" aria-hidden="true"><path d="M5 16c0-.531.469-1 1.031-1H17.97c.562 0 1.031.469 1.031 1 0 .563-.469 1-1.031 1H6.03C5.47 17 5 16.562 5 16zm0-4c0-.531.469-1 1.031-1H15c.531 0 1 .469 1 1s-.469 1-1 1H6.031C5.47 13 5 12.531 5 12zm0-4c0-.563.469-1 1.031-1H17.97C18.53 7 19 7.438 19 8c0 .531-.469 1-1.031 1H6.03C5.47 9 5 8.531 5 8z" fill="currentColor" fill-rule="evenodd"></path></svg>
              <span aria-hidden="false">Hauptmenü</span>
            </button>
          </span>
        </div>
      </header>
      <main class="content">
        <div class="dashboard-account-container">
          <div style="display: flex;">
            <div style="flex: 3;"><span class="db-body db-fs5 t:db-fs5 d:db-fs5 db-body--secondary" style="padding: 0.8rem">Welcome: <b>{{ username }}</b></span></div>
            <div style="flex: 1; text-align: right;">
              <a class="db-link db-link--primary db-link--icon" style="padding: 0.9rem;" href="/auth/signout">
              <span>Sign out</span>
              <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="db-icon" role="img"><path d="M4 18a3 3 0 003 3h4c.563 0 1-.438 1-1 0-.563-.438-1-1-1H7c-.563 0-1-.438-1-1V6c0-.563.438-1 1-1h4c.563 0 1-.438 1-1 0-.563-.438-1-1-1H7a3 3 0 00-3 3v12zm5.5-6c0 .531.438 1 1 1h7.594l-2.282 2.281a1.043 1.043 0 00-.28.719c0 .563.437 1 .968 1 .25 0 .531-.125.719-.313l4-3.968c.187-.188.281-.469.281-.719s-.094-.531-.281-.719l-4-3.969a.95.95 0 00-1.406 0A.97.97 0 0015.53 8c0 .25.094.5.281.719L18.095 11H10.5c-.563 0-1 .438-1 1z" fill="currentColor" fill-rule="evenodd"></path></svg>
              </a>
          </div>
          </div>
        </div>
        <div class="spacer-container"></div>
        <div class="dashboard-container">
          <div>
            <h2><span class="db-headline db-fs7 t:db-fs8 d:db-fs8">Two-factor authentication</span></h2>
          </div>
          <div class="button-container-left">
            <button id="registerButton" class="db-button db-button--primary db-button--default db-button--size-s db-button--icon-position-before">
              <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" class="db-icon" role="img"><path d="M2 18.969C2 20.625 3.313 22 4.969 22h8c1.656 0 3-1.375 3-3.031V17.03c0-.531-.469-1.031-1-1.031-.563 0-.969.5-1 1.031v1.938c0 .562-.438 1.031-1 1.031h-8C4.437 20 4 19.531 4 18.969V5.03c0-.562.438-1 .969-1H8c.531-.031.969-.437.969-1 0-.562-.438-.969-.969-1H4.969C3.312 2.031 2 3.375 2 5.031V18.97zM5 17c0 .531.438 1 1 1 .563 0 1-.469 1-1 0-.563-.438-1-1-1-.563 0-1 .438-1 1zm3 0c0 .531.469 1 1 1 .563 0 1-.469 1-1 0-.563-.438-1-1-1-.531 0-1 .438-1 1zm1.063-6.781c.062.25.28.5.562.594l.656.25a.994.994 0 01.625.843l.031.719c0 .281.157.563.376.719.25.156.53.219.812.125l.688-.188c.374-.094.75.063 1 .344l.437.563a.998.998 0 00.75.343c.281 0 .563-.125.719-.344l.469-.562c.25-.281.625-.438 1-.344l.687.188c.281.094.594.031.781-.125.25-.156.375-.438.407-.719l.062-.719c0-.375.25-.719.594-.844l.656-.25c.281-.093.469-.343.563-.593a.933.933 0 00-.094-.813l-.375-.594c-.219-.343-.219-.75 0-1.03l.375-.626c.156-.218.187-.531.093-.812-.093-.25-.28-.5-.562-.594l-.656-.25c-.344-.156-.594-.469-.594-.844l-.063-.718c-.03-.282-.156-.563-.406-.72-.187-.155-.5-.218-.781-.155l-.688.187c-.375.094-.75 0-1-.313l-.468-.562A.917.917 0 0015 2c-.281 0-.563.156-.75.375l-.438.563c-.25.312-.624.406-1 .312l-.687-.188c-.281-.062-.563 0-.813.157a.917.917 0 00-.374.719l-.032.718c-.031.375-.281.688-.625.844l-.656.25a.887.887 0 00-.563.594c-.093.281-.062.593.094.812l.406.625c.188.282.188.688 0 1.032l-.406.593a.932.932 0 00-.094.813zM11 17c0 .531.438 1 1 1 .531 0 1-.469 1-1 0-.563-.469-1-1-1-.563 0-1 .438-1 1zm.906-10.906a.84.84 0 01.844-.844c.469 0 .875.375.875.844a.894.894 0 01-.875.875c-.469 0-.844-.407-.844-.875zm.625 4.156c-.125-.281-.031-.563.156-.781l3.407-3.406.093-.063a.757.757 0 01.97.063c.28.28.28.75 0 1.062l-3.407 3.406-.094.063c-.094.094-.281.125-.437.125-.313 0-.563-.188-.688-.469zm3.875.375c0-.469.375-.875.844-.875s.844.406.844.875a.84.84 0 01-.844.844.84.84 0 01-.844-.844z" fill="currentColor" fill-rule="evenodd"></path></svg>
              <span>Add a credential</span>
            </button>
            <span class="db-inline-spacer"> </span>
          </div>
          <div id="credentials"></div>
          <div class="spacer-container"></div>
        </div>     
    </main>
    <script type="module">
      import {
        _fetch,
        registerCredential,
        removeCredential,
        renameCredential
      } from "/auth.client.js";
      import { getCredentialListHtml } from "/templates.js";
      import { render } from "https://unpkg.com/lit-html@1.0.0/lit-html.js?module";

      // Initialize the credential list by updating it once on page load
      updateCredentialList();

      // Set up the handler for the button that registers credentials
      const registerButton = document.querySelector('#registerButton');
      registerButton.addEventListener('click', register);

      // Register a credential
      async function register() {
        let user = {};
        try {
          const user = await registerCredential();
          // Get the latest credential's ID (newly created credential)
          const allUserCredentials = user.credentials;
          const newCredential = allUserCredentials[allUserCredentials.length - 1];
          // Rename it
          await rename(newCredential.credId);
        } catch (e) {
          // Alert the user that something went wrong
          if (Array.isArray(e)) {
            alert(
              // `msg` not `message`, this is the key's name as per the express validator API
              `Registration failed. ${e.map((err) => `${err.msg} (${err.param})`)}`
            );
          } else {
            alert(`Registration failed. ${e}`);
          }
        }

        // Refresh the credential list to display the new credential
        await updateCredentialList();
      }

      // Rename a credential
      async function rename(credentialId) {
        // Let the user input a new name
        const newName = window.prompt(`Name this credential:`);
        // Rename only if the user didn't cancel AND didn't enter an empty name
        if (newName && newName.trim()) {
          try {
            // Make the backend call to rename the credential (the name is sanitized) server-side
            await renameCredential(credentialId, newName);
          } catch (e) {
            // Alert the user that something went wrong
            if (Array.isArray(e)) {
              alert(
                // `msg` not `message`, this is the key's name as per the express validator API
                `Renaming failed. ${e.map((err) => `${err.msg} (${err.param})`)}`
              );
            } else {
              alert(`Renaming failed. ${e}`);
            }
          }
          // Refresh the credential list to display the new name
          await updateCredentialList();
        }
      }

      // Rename a credential via HTML element
      async function renameEl(el) {
        // Define the ID of the credential to update
        const credentialId = el.srcElement.dataset.credentialId;
        // Rename the credential
        await rename(credentialId);
        // Refresh the credential list to display the new name
        await updateCredentialList();
      }

      // Remove a credential via HTML element
      async function removeEl(el) {
        // Define the ID of the credential to remove
        const credentialId = el.srcElement.dataset.credentialId;
        // Remove the credential
        await removeCredential(credentialId);
        // Refresh the credential list
        await updateCredentialList();
      }

      // Update the list that displays credentials
      async function updateCredentialList() {
        // Fetch the latest credential list from the backend
        const response = await _fetch('/auth/credentials', 'GET');
        const credentials = response.credentials || [];

        // sort credentials based on usage
        credentials.sort((cred1, cred2) => {
          return compareObjects(cred1, cred2, 'lastUsedDate')
        }).reverse();

        // Generate the credential list as HTML and pass remove/rename functions as args
        const credentialListHtml = getCredentialListHtml(
          credentials,
          removeEl,
          renameEl
        );
        // Display the list of credentials in the DOM
        const list = document.querySelector('#credentials');
        render(credentialListHtml, list);
      } 

      function compareObjects(object1, object2, key) {
        const obj1 = object1[key];
        const obj2 = object2[key];

        if (obj1 < obj2) {
          return -1
        }
        if (obj1 > obj2) {
          return 1
        }
        return 0
      }
    </script>
  </body>
</html>
